<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Verve Juice Order</title>

  <!-- Tailwind & Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- Fonts -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&family=Noto+Sans+Thai:wght@300;400;600;700&display=swap');

    body {
      font-family: 'Noto Sans Thai', sans-serif;
      /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏•‡πà‡∏™‡∏µ‡∏™‡∏î‡πÉ‡∏™‡πÅ‡∏•‡∏∞‡∏°‡∏µ Animation ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏ö‡∏≤‡πÜ */
      background: linear-gradient(135deg, #34d399 0%, #facc15 50%, #fb923c 100%);
      background-size: 200% 200%;
      animation: gradientShift 15s ease infinite;
      -webkit-tap-highlight-color: transparent;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .cute-font { font-family: 'Kanit', sans-serif; }
    
    /* Glassmorphism Card Style */
    .glass-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* Modern Card Hover Effects */
    .menu-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(0,0,0,0.05);
    }
    .menu-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      border-color: #10b981;
    }
    .menu-card:active { transform: scale(0.98); }

    /* Button Styling */
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
      transform: translateY(-1px);
    }
    .btn-primary:active { transform: translateY(1px); }

    /* Animations */
    .floating-logo { animation: float 6s ease-in-out infinite; }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 20px; height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

    /* Form Inputs */
    .input-modern {
      background-color: #f9fafb;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }
    .input-modern:focus {
      background-color: #fff;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      outline: none;
    }

    /* Social Glows */
    @keyframes line-glow-anim {
      0%, 100% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0); }
      50% { box-shadow: 0 0 12px 3px rgba(6, 199, 85, 0.4); }
    }
    .line-icon-glow { animation: line-glow-anim 2s infinite ease-in-out; border-radius: 18px; }
    
    .tiktok-icon-glow { filter: drop-shadow(2px 2px 0px rgba(0,242,234,0.4)) drop-shadow(-2px -2px 0px rgba(255,0,80,0.4)); }
    .ig-icon-glow { filter: drop-shadow(0 2px 4px rgba(131,58,180,0.3)); }

    /* Best Seller Badge Animation */
    @keyframes shine {
        0% { transform: translateX(-100%) rotate(45deg); }
        100% { transform: translateX(100%) rotate(45deg); }
    }
    .badge-shine {
        position: relative;
        overflow: hidden;
    }
    .badge-shine::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 2s infinite;
    }

  </style>
</head>
<body class="flex items-start justify-center min-h-screen p-4 pt-6 pb-20">

<div class="container glass-card p-4 sm:p-6 rounded-3xl w-full max-w-lg transition-all duration-300 relative z-10">

  <!-- ==================== MENU SECTION ==================== -->
  <div id="order-form-section">
    <!-- Header Logo -->
    <div class="flex justify-center mb-8 floating-logo relative">
        <div class="absolute inset-0 bg-white/40 blur-3xl rounded-full scale-125"></div>
        <div class="relative z-10">
            <img src="https://github.com/kornkawes/VerveImage/blob/main/logo2.png?raw=true"
                 alt="Verve Juice Logo" class="w-64 h-auto object-contain drop-shadow-xl" />
        </div>
    </div>

    <!-- Social Links -->
    <div class="flex flex-wrap justify-center gap-2 mb-6 w-full px-2">
        <a href="https://www.tiktok.com/@vervejuice.th" target="_blank" 
           class="flex items-center gap-2 px-3 py-1.5 bg-white rounded-full border border-gray-100 shadow-sm text-gray-700 text-xs font-bold hover:scale-105 transition-transform no-underline">
            <i class="fa-brands fa-tiktok text-lg tiktok-icon-glow"></i> VerveJuice
        </a>
        <a href="https://lin.ee/Z5hDNAQ" target="_blank" 
           class="flex items-center gap-2 px-4 py-1.5 bg-[#06c755] text-white rounded-full shadow-md text-xs font-bold hover:scale-105 transition-transform no-underline line-icon-glow">
            <i class="fa-brands fa-line text-lg"></i> ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        </a>
        <a href="https://www.instagram.com/vervejuice.th" target="_blank" 
           class="flex items-center gap-2 px-3 py-1.5 bg-white rounded-full border border-gray-100 shadow-sm text-gray-700 text-xs font-bold hover:scale-105 transition-transform no-underline">
            <i class="fa-brands fa-instagram text-lg ig-icon-glow text-fuchsia-600"></i> VerveJuice
        </a>
    </div>

    <!-- Announcement Box -->
    <div class="mb-6 mx-1 p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-2xl border border-orange-200 text-sm text-gray-700 relative overflow-hidden shadow-inner group hover:shadow-md transition-shadow">
      <div class="absolute -right-6 -top-6 bg-orange-300 w-24 h-24 rounded-full opacity-10 blur-xl group-hover:opacity-20 transition-opacity"></div>
      <div class="absolute -left-6 -bottom-6 bg-yellow-300 w-20 h-20 rounded-full opacity-10 blur-xl"></div>
      
      <div class="space-y-3 relative z-10">
        <div class="text-center">
            <div class="inline-flex items-center gap-2 bg-white/80 px-3 py-1 rounded-full mb-2 shadow-sm backdrop-blur-sm border border-orange-100">
                <i class="fas fa-map-marker-alt text-orange-500 animate-bounce"></i>
                <span class="font-bold text-orange-800 text-xs uppercase tracking-wide">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å</span>
            </div>
            <div class="flex flex-col gap-1 text-xs sm:text-sm font-medium text-gray-600">
                <span>üè¢ ‡∏™‡∏≤‡∏ó‡∏£ / Park Silom</span>
                <span>üèõÔ∏è ‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£ / ‡∏®‡∏≤‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏ó‡∏°. 1</span>
                <span>üè° ‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢ / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ß‡∏ô‡∏ä‡∏°</span>
            </div>
            <p class="text-[10px] text-gray-400 mt-1 flex items-center justify-center gap-1">
                <i class="fas fa-info-circle"></i> ‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
            </p>
        </div>
        <div class="h-px bg-orange-200 w-3/4 mx-auto opacity-50"></div>
        <div class="flex items-start gap-3 bg-white/60 p-3 rounded-xl border border-orange-100">
             <div class="bg-orange-100 p-2 rounded-lg text-orange-600 flex-shrink-0">
                 <i class="fas fa-bullhorn"></i>
             </div>
             <div>
                 <p class="font-bold text-gray-800 text-xs mb-0.5">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô</p>
                 <p class="text-[11px] text-gray-600 leading-relaxed">
                     ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ Verve Juice ‡∏°‡∏µ <b>Line Official Account</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡πâ‡∏≤! 
                     ‡πÅ‡∏≠‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÜ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üéâ
                 </p>
             </div>
        </div>
      </div>
    </div>

    <!-- Menu Title -->
    <div class="flex items-center justify-between mb-4 px-1">
        <div class="flex items-center gap-2">
            <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600"><i class="fas fa-leaf"></i></div>
            <h2 class="text-2xl font-bold gradient-text cute-font text-gray-800">‡πÄ‡∏°‡∏ô‡∏π</h2>
        </div>
    </div>

    <!-- Menu Grid -->
    <div id="menu-items" class="space-y-4 pb-10"></div>
  </div>

  <!-- ==================== PAYMENT SECTION ==================== -->
  <div id="payment-section" class="hidden animate-fade-in">
    <!-- Payment Header -->
    <div class="flex items-center gap-3 mb-6 border-b pb-4">
        <button id="back-to-menu-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-colors text-gray-600">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div>
            <h1 class="text-xl font-bold text-gray-800 cute-font">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô & ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h1>
            <p class="text-xs text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
        </div>
    </div>

    <div class="space-y-5">
      <!-- Info Form -->
      <div class="space-y-3">
        <div>
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
            <div class="grid grid-cols-1 gap-3">
                <input id="customerName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                    class="w-full px-4 py-3 rounded-xl input-modern text-sm" />
                <input id="customerPhone" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (10 ‡∏´‡∏•‡∏±‡∏Å)"
                    class="w-full px-4 py-3 rounded-xl input-modern text-sm" />
            </div>
        </div>
      </div>

      <!-- Location Card -->
      <div class="bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100">
        <label class="block text-xs font-bold text-emerald-700 mb-2 flex items-center gap-1">
            <i class="fas fa-map-marker-alt"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà & ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
        </label>
        
        <select id="deliveryLocation"
                class="w-full px-4 py-3 rounded-xl input-modern bg-white text-sm mb-3 cursor-pointer">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
          <option value="sathorn">‡∏™‡∏≤‡∏ó‡∏£ / Park Silom</option>
          <option value="PhraNakhon">‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£ / ‡∏®‡∏≤‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏ó‡∏°.</option>
          <option value="sainoi">‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢ / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ß‡∏ô‡∏ä‡∏°</option>
        </select>

        <div id="delivery-dates-container" class="space-y-2 text-sm text-gray-600 bg-white p-3 rounded-xl border border-emerald-100 min-h-[60px] flex flex-col justify-center">
          <p class="text-center text-gray-400 text-xs">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô</p>
        </div>
        <p id="delivery-warning" class="text-[10px] text-orange-500 mt-2 hidden"><i class="fas fa-exclamation-circle"></i> ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</p>
        
        <!-- UPDATED: LINE BUTTON (MORE PROMINENT) -->
        <div class="mt-3 flex justify-end">
             <a href="https://lin.ee/Z5hDNAQ" target="_blank" 
                class="inline-flex items-center gap-2 px-3 py-1.5 bg-white border border-emerald-200 rounded-full shadow-sm text-[11px] font-bold text-emerald-700 hover:bg-emerald-50 hover:text-emerald-800 transition-all no-underline transform hover:scale-105 group">
                <i class="fa-brands fa-line text-lg text-[#06c755] group-hover:scale-110 transition-transform"></i>
                <span>‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà? ‡∏ó‡∏±‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</span>
             </a>
        </div>

      </div>

      <!-- Note -->
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="customerNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ grab/lineman ‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏ö‡∏£‡∏±‡∏ö ‡∏ï‡∏∂‡∏Å Park Silom"
                  class="w-full px-4 py-3 rounded-xl input-modern text-sm resize-none h-20"></textarea>
      </div>

      <!-- Summary Card -->
      <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm relative overflow-hidden">
        <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-50 rounded-bl-full -mr-10 -mt-10 z-0"></div>
        <div class="relative z-10">
            <h3 class="text-sm font-bold text-gray-800 mb-3 border-b pb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            <div id="order-summary" class="text-sm text-gray-600 space-y-1 mb-4"></div>

            <!-- Discount -->
            <div class="flex gap-2 mb-3">
                <input id="discountCode" type="text" placeholder="CODE"
                    class="flex-1 px-3 py-2 text-sm rounded-lg border border-gray-200 bg-gray-50 focus:outline-none focus:border-emerald-500 uppercase tracking-widest text-center" />
                <button id="apply-discount-btn" class="px-4 py-2 bg-gray-800 text-white text-xs font-bold rounded-lg hover:bg-gray-700 transition-colors">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
            </div>
            <p id="discount-info" class="text-xs mb-2 h-4 text-center"></p>

            <!-- Totals -->
            <div id="total-summary-section" class="space-y-1 pt-2 border-t">
                <div class="flex justify-between text-gray-500 text-xs">
                    <span>‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><span id="subtotal-price">‡∏ø0</span>
                </div>
                <div id="discount-display-section" class="flex justify-between text-red-500 text-xs hidden">
                    <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î <span id="discount-code-display" class="bg-red-50 px-1 rounded"></span></span>
                    <span id="discount-amount">-‡∏ø0</span>
                </div>
                <div class="flex justify-between items-end mt-2">
                    <span class="font-bold text-gray-800">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                    <span id="total-price" class="text-2xl font-bold text-emerald-600 cute-font">‡∏ø0</span>
                </div>
            </div>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm text-center">
        <h3 class="font-bold text-gray-800 mb-3">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
        
        <div class="flex flex-col items-center">
            <div id="qr-display-container" class="w-48 h-48 border-2 border-emerald-100 rounded-2xl p-2 bg-white mb-3">
                <img id="qrCodeImage"
                    src="https://github.com/kornkawes/Image/blob/main/unnamed%20(1).jpg?raw=true"
                    alt="QR Code" class="w-full h-full object-contain rounded-xl"
                    onerror="this.onerror=null;this.src='https://placehold.co/400x400/eeeeee/333333?text=QR+Code';showMessageBox('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','red');">
            </div>
            
            <div class="bg-gray-50 rounded-xl p-3 w-full border border-gray-100">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs text-gray-500">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</span>
                    <span class="text-xs font-bold text-gray-700">‡∏ô‡∏≤‡∏¢ ‡∏Å‡∏£‡∏Å‡∏ß‡∏µ ‡∏™‡∏≤‡∏¢‡πÄ‡∏û‡∏ä‡∏£</span>
                </div>
                <div class="flex items-center justify-between bg-white px-3 py-2 rounded-lg border border-gray-200 cursor-pointer hover:border-emerald-400 transition-colors group" id="copy-account-btn">
                    <span class="font-mono font-bold text-gray-800 text-lg tracking-wider" id="bank-account-number">014-1-08305-8</span>
                    <i class="fas fa-copy text-gray-400 group-hover:text-emerald-500"></i>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p>
            </div>
        </div>
      </div>

      <!-- Slip Upload (FIXED: Explicit Click Area) -->
      <div>
        <label class="block w-full p-4 border-2 border-dashed border-emerald-300 rounded-2xl bg-emerald-50/30 text-center cursor-pointer hover:bg-emerald-50 transition-colors relative group overflow-hidden" id="slip-drop-zone">
            <input id="slipUpload" type="file" accept="image/*" class="hidden" />
            <div class="relative z-10 transition-transform group-hover:scale-105">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm text-emerald-500">
                    <i class="fas fa-cloud-upload-alt text-xl"></i>
                </div>
                <p class="text-sm font-bold text-emerald-700">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô*</p>
                <p class="text-xs text-emerald-500">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
            </div>
        </label>
        
        <div id="slip-preview-container" class="hidden mt-3 p-2 bg-white border rounded-xl relative">
             <button onclick="clearSlip()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs shadow-md z-10">&times;</button>
             <img id="slip-preview" src="#" class="w-full h-40 object-contain rounded-lg" />
        </div>
      </div>

      <button id="upload-slip-btn" class="w-full btn-primary text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-xl text-lg flex items-center justify-center gap-2">
        <span id="upload-slip-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
        <div id="upload-slip-spinner" class="spinner hidden"></div>
      </button>
      
      <div class="h-10"></div>
    </div>
  </div>

  <!-- ==================== CONFIRMATION SECTION ==================== -->
  <div id="confirmation-section" class="hidden text-center pt-8">
    <div class="w-24 h-24 bg-gradient-to-tr from-green-400 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl shadow-emerald-200 animate-bounce">
      <i class="fas fa-check text-5xl text-white"></i>
    </div>
    <h1 class="text-3xl font-bold text-gray-800 cute-font mb-2">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö!</h1>
    <p class="text-gray-500 mb-8">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</p>

    <div id="final-order-summary" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 text-left mb-6 text-sm relative">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-green-500 rounded-t-2xl"></div>
        <!-- JS injected content -->
    </div>

    <button onclick="window.location.reload()"
            class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-700 transition-colors shadow-lg">
      ‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
    </button>
    <p class="text-xs text-red-400 mt-4 opacity-70">*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
  </div>

</div>

<!-- Item Selection Modal -->
<div id="item-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden">
  <div id="modal-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0"></div>
  <div id="modal-content" class="relative bg-white rounded-3xl shadow-2xl w-[90%] max-w-sm transform scale-95 transition-transform duration-300 overflow-hidden">
    <!-- Close Button -->
    <button onclick="closeItemModal()" class="absolute top-4 right-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200 z-10">&times;</button>
    
    <!-- JS Content -->
    <div id="modal-body" class="p-6"></div>
  </div>
</div>

<!-- Cart Sidebar -->
<div id="cart-sidebar" class="fixed inset-0 z-50 flex items-end hidden">
  <div id="cart-overlay" class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity opacity-0"></div>
  <div id="cart-content" class="relative w-full max-w-lg mx-auto bg-white h-[85vh] shadow-2xl transform translate-y-full transition-transform duration-300 flex flex-col rounded-t-3xl">
    
    <!-- Drag Handle -->
    <div class="w-full flex justify-center pt-3 pb-1" onclick="closeCartSidebar()">
        <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
    </div>

    <div class="px-6 py-4 flex justify-between items-center border-b border-gray-100">
      <h2 class="text-xl font-bold text-gray-800 cute-font">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <button id="close-cart-btn" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-times-circle text-2xl"></i></button>
    </div>

    <div id="cart-items-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"></div>

    <div class="p-6 bg-white border-t border-gray-100 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] safe-area-pb">
      <div class="flex justify-between items-center text-lg mb-4">
        <span class="font-bold text-gray-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
        <span id="cart-subtotal" class="font-extrabold text-2xl text-emerald-600">‡∏ø0</span>
      </div>
      <button id="checkout-from-cart-btn" class="w-full btn-primary text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-emerald-200 text-lg flex items-center justify-center gap-2">
        ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô <i class="fas fa-arrow-right text-sm"></i>
      </button>
    </div>
  </div>
</div>

<!-- Floating Cart Button -->
<div id="floating-cart-btn" class="fixed bottom-6 left-0 right-0 z-40 px-6 hidden pointer-events-none">
  <button id="open-cart-popup-btn"
          class="w-full max-w-sm mx-auto bg-gray-900/90 backdrop-blur-md text-white p-4 rounded-2xl shadow-2xl flex items-center justify-between border border-gray-700 pointer-events-auto transform transition-all hover:scale-[1.02] active:scale-95">
          <!-- Content Injected via JS -->
  </button>
</div>

<script>
window.getEl = id => document.getElementById(id);

// --- GLOBAL STATE ---
let order = { items:{}, total:0, subtotal:0, discount:null, totalItems:0 };
let menu = [];
let updateTotal = () => {};
let renderCartSidebarContent = () => {};

// Helper for animations
const animateModalOpen = () => {
    getEl('modal-overlay').classList.remove('opacity-0');
    getEl('modal-content').classList.remove('scale-95');
    getEl('modal-content').classList.add('scale-100');
};
const animateModalClose = () => {
    getEl('modal-overlay').classList.add('opacity-0');
    getEl('modal-content').classList.add('scale-95');
    getEl('modal-content').classList.remove('scale-100');
};

// ===== MODAL LOGIC =====
window.changeModalQty = (inputId, change) => {
  const qtyInput = getEl(inputId);
  let currentQty = parseInt(qtyInput.value);
  let newQty = Math.max(1, currentQty + change);
  qtyInput.value = newQty;
};

window.openItemModal = (id) => {
  const item = menu.find(i => i.id === id);
  const modalBody = getEl('modal-body');

  const allergyOptionsHtml = item.ingredients.split(',').map(ing => {
    const trimmed = ing.trim();
    return `<label class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer border border-transparent hover:border-gray-200 transition-colors">
              <input type="checkbox" name="modal-allergy-${id}" value="${trimmed}" class="w-4 h-4 text-emerald-500 rounded border-gray-300 focus:ring-emerald-500">
              <span class="text-sm text-gray-700">${trimmed}</span>
            </label>`;
  }).join('');

  const sizeOptionsHtml = item.sizes.map(size => {
    return `<option value="${size.size}" data-price="${size.price}">
              ${size.size} - ‡∏ø${size.price}
            </option>`;
  }).join('');

  modalBody.innerHTML = `
    <div class="text-center mb-5">
        <img src="${item.imageUrl}" class="w-32 h-32 object-cover rounded-2xl mx-auto shadow-lg mb-3">
        <h3 class="text-2xl font-bold text-gray-800 cute-font">${item.name}</h3>
        <p class="text-xs text-gray-500 px-4">${item.properties}</p>
        <div class="mt-2 text-xs text-emerald-600 bg-emerald-50 inline-block px-3 py-1 rounded-full border border-emerald-100">
            <i class="fas fa-flask"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°: ${item.ingredients}
        </div>
    </div>
    
    <div class="space-y-4">
      <div>
        <label for="modal-size-select" class="block text-xs font-bold text-gray-500 mb-1 ml-1">‡∏Ç‡∏ô‡∏≤‡∏î</label>
        <select id="modal-size-select" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-emerald-500 bg-gray-50 text-sm font-semibold">
          ${sizeOptionsHtml}
        </select>
      </div>
      
      <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
        <p class="font-bold text-gray-700 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
        <div class="flex items-center gap-3">
          <button onclick="changeModalQty('modal-qty-input', -1)" class="w-8 h-8 rounded-lg bg-white border border-gray-200 text-gray-600 hover:bg-gray-100 transition-colors shadow-sm">-</button>
          <input type="number" id="modal-qty-input" class="w-10 text-center font-bold bg-transparent text-lg" value="1" readonly>
          <button onclick="changeModalQty('modal-qty-input', 1)" class="w-8 h-8 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600 transition-colors shadow-emerald-200 shadow-md">+</button>
        </div>
      </div>

      <div class="border-t pt-3">
        <details class="group">
            <summary class="flex items-center gap-2 cursor-pointer text-sm font-bold text-gray-500 hover:text-emerald-600 list-none">
                <i class="fas fa-chevron-right text-xs transition-transform group-open:rotate-90"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà)
            </summary>
            <div id="allergy-options-${id}" class="mt-3 grid grid-cols-1 gap-1">
                ${allergyOptionsHtml}
                <p class="text-[10px] text-red-400 mt-1 pl-1">*‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏Å‡∏ï‡∏¥</p>
            </div>
        </details>
      </div>
    </div>
    
    <button onclick="confirmItemSelection('${id}')" class="w-full mt-6 bg-emerald-600 text-white font-bold py-3.5 rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transform active:scale-95 transition-all">
        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    </button>`;

  getEl('item-modal').classList.remove('hidden');
  setTimeout(animateModalOpen, 10);
};

window.confirmItemSelection = (id) => {
  const sizeSelectEl = getEl('modal-size-select');
  const selectedOption = sizeSelectEl.options[sizeSelectEl.selectedIndex];
  const size = selectedOption.value;
  const price = parseFloat(selectedOption.dataset.price);
  const quantity = parseInt(getEl('modal-qty-input').value);
  
  if (quantity <= 0) return closeItemModal();

  const allergyNodes = document.querySelectorAll(`input[name="modal-allergy-${id}"]:checked`);
  const allergies = Array.from(allergyNodes).map(node => node.value).sort();
  const allergyKey = allergies.length > 0 ? allergies.join(',') : 'none';
  const compositeId = `${id}-${size}-${allergyKey}`;

  if (order.items[compositeId]) {
    order.items[compositeId].quantity += quantity;
  } else {
    const itemData = menu.find(i => i.id === id);
    order.items[compositeId] = {
      id: id, name: itemData.name, size: size,
      price: price, quantity: quantity, allergies: allergies, imageUrl: itemData.imageUrl
    };
  }

  updateTotal();
  closeItemModal();
  showMessageBox(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${menu.find(i=>i.id===id).name} ‡πÅ‡∏•‡πâ‡∏ß`, 'green');
};

window.closeItemModal = () => {
  animateModalClose();
  setTimeout(() => { 
      getEl('item-modal').classList.add('hidden'); 
      getEl('modal-body').innerHTML = ''; 
  }, 300);
};

window.adjustItem = (menuId, size, allergyKey, delta) => {
  const key = `${menuId}-${size}-${allergyKey}`;
  if (!order.items[key]) return;
  order.items[key].quantity += delta;
  if (order.items[key].quantity <= 0) delete order.items[key];
  updateTotal();
};

window.openCartSidebar = () => {
  renderCartSidebarContent();
  const sidebar = getEl('cart-sidebar');
  sidebar.classList.remove('hidden');
  requestAnimationFrame(() => {
      sidebar.querySelector('#cart-overlay').classList.remove('opacity-0');
      sidebar.querySelector('#cart-content').classList.remove('translate-y-full');
  });
};

window.closeCartSidebar = () => {
  const sidebar = getEl('cart-sidebar');
  sidebar.querySelector('#cart-overlay').classList.add('opacity-0');
  sidebar.querySelector('#cart-content').classList.add('translate-y-full');
  
  setTimeout(() => sidebar.classList.add('hidden'), 300);
};

renderCartSidebarContent = () => {
  const listEl = getEl('cart-items-list');
  const subtotalEl = getEl('cart-subtotal');
  listEl.innerHTML = '';

  if (order.totalItems === 0) {
    listEl.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <i class="fas fa-shopping-basket text-4xl mb-3 opacity-30"></i>
            <p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
            <button onclick="closeCartSidebar()" class="text-emerald-500 font-bold mt-2 text-sm hover:underline">‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>`;
  } else {
    const itemsToRender = Object.values(order.items).sort((a,b) => a.name.localeCompare(b.name));
    itemsToRender.forEach(item => {
      if (item.quantity <= 0) return;
      const allergyKey = (item.allergies && item.allergies.length) ? item.allergies.join(',') : 'none';
      const safeAllergyKey = allergyKey.replace(/'/g, "\\'");
      const itemData = menu.find(i => i.id === item.id);
      const imgUrl = item.imageUrl || (itemData ? itemData.imageUrl : '');

      listEl.innerHTML += `
        <div class="flex gap-3 p-3 bg-white rounded-xl border border-gray-100 shadow-sm transition-all hover:shadow-md">
          <div class="w-16 h-16 rounded-lg bg-gray-100 flex-shrink-0 overflow-hidden">
             <img src="${imgUrl}" alt="${item.name}" class="w-full h-full object-cover">
          </div>
          <div class="flex-1 min-w-0 flex flex-col justify-between py-0.5">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold text-gray-800 text-sm truncate leading-tight">${item.name}</p>
                    <p class="text-xs text-gray-500">${item.size}</p>
                </div>
                <p class="text-sm font-bold text-gray-800">‡∏ø${(item.price * item.quantity).toFixed(0)}</p>
            </div>
            
            <div class="flex justify-between items-end mt-1">
                <div class="text-[10px] text-red-500 truncate max-w-[80px]">
                    ${item.allergies.length > 0 ? `‡πÅ‡∏û‡πâ: ${item.allergies.join(', ')}` : ''}
                </div>
                <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-1 border border-gray-100">
                    <button class="w-5 h-5 flex items-center justify-center rounded bg-white text-gray-600 text-xs shadow-sm hover:text-red-500"
                            onclick="adjustItem('${item.id}','${item.size}','${safeAllergyKey}', -1)">-</button>
                    <span class="w-4 text-center text-xs font-bold text-gray-700">${item.quantity}</span>
                    <button class="w-5 h-5 flex items-center justify-center rounded bg-emerald-500 text-white text-xs shadow-sm hover:bg-emerald-600"
                            onclick="adjustItem('${item.id}','${item.size}','${safeAllergyKey}', 1)">+</button>
                </div>
            </div>
          </div>
        </div>
      `;
    });
  }
  subtotalEl.textContent = `‡∏ø${order.subtotal.toFixed(0)}`;
};

window.clearSlip = () => {
    getEl('slipUpload').value = "";
    getEl('slip-preview-container').classList.add('hidden');
    getEl('slip-preview').src = "#";
}

document.addEventListener('DOMContentLoaded', () => {
  const deliveryConfig = {
    sathorn: { label: '‡∏™‡∏≤‡∏ó‡∏£ / ‡∏ï‡∏∂‡∏Å Park Silom', weekdays: [1, 2, 3] },
    PhraNakhon: { label: '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£ / ‡∏®‡∏≤‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏ó‡∏°.', weekdays: [1, 2, 3, 4, 5] },
    sainoi: { label: '‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢ / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ß‡∏ô‡∏ä‡∏°', weekdays: [1, 2, 3, 4, 5] }
  };
  const DELIVERY_WEEKS_AHEAD = 1;

  const local_menu = [
    { id:'apple-kiss', name:'Apple Kiss', ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏Ç‡∏¥‡∏á, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ú‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î, ‡∏•‡∏î‡∏à‡∏∏‡∏î‡∏î‡πà‡∏≤‡∏á‡∏î‡∏≥', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/apple%20kiss.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'blush-bloom', name:'Blush Bloom', ingredients:'‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®, ‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏ä‡πà‡∏ß‡∏¢‡∏ú‡∏•‡∏±‡∏î‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ú‡∏¥‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏£‡∏¥‡πâ‡∏ß‡∏£‡∏≠‡∏¢', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/blush%20bloom.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'Pure-guava', name:'Pure Guava', ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏ù‡∏£‡∏±‡πà‡∏á, ‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©, ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/lime%20guava.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'hearty-green', name:'Hearty Green', ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î, ‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', properties:'‡∏•‡∏î‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/hearty%20green.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'sweet-detox', name:'Sweet Detox', ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó, ‡∏ö‡∏µ‡∏ó‡∏£‡∏π‡∏ó', properties:'‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/sweet%20detox.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}], isBestSeller: true},
    { id:'beet-love', name:'Beet Love', ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡∏ö‡∏µ‡∏ó‡∏£‡∏π‡∏ó, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/beet%20love.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'smart-sip', name:'Smart Sip', ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡πÄ‡∏Ñ‡∏•, ‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', properties:'‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏¢‡∏ï‡∏≤', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/smart%20sip.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}], isBestSeller: true},
    { id:'recharge-me', name:'Recharge Me', ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡∏Ç‡∏¥‡∏á, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏•‡πâ‡∏≤', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/recharge%20me.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
  ];
  const local_discountCodes = [
    { code:"VJLINE10", type:"percent", value:10, expiryDate:"2025-12-31", minSpend:0, minItems:3, maxDiscount:40 },
    { code:"SUCHATANDSOMPOP", type:"fixed", value:20, expiryDate:"2025-12-31", minSpend:0, minItems:3, maxDiscount:20 }
  ];
  const n8nWebhookUrl = "https://n8n-verve-u61532.vm.elestio.app/webhook/3292a5c3-0f7f-424f-92f8-7dc42f51d763";

  menu = local_menu;

  const orderFormSection = getEl('order-form-section'), paymentSection = getEl('payment-section');
  const confirmationSection = getEl('confirmation-section'), menuItemsEl = getEl('menu-items');
  const customerNameEl = getEl('customerName'), customerPhoneEl = getEl('customerPhone');
  const customerNoteEl = getEl('customerNote'), deliveryLocationEl = getEl('deliveryLocation');
  const deliveryDatesContainerEl = getEl('delivery-dates-container');
  const deliveryWarningEl = getEl('delivery-warning'), discountCodeInputEl = getEl('discountCode');
  const applyDiscountBtnEl = getEl('apply-discount-btn'), discountInfoEl = getEl('discount-info');
  const subtotalPriceEl = getEl('subtotal-price'), discountAmountEl = getEl('discount-amount');
  const totalPriceEl = getEl('total-price'), discountDisplaySectionEl = getEl('discount-display-section');
  const discountCodeDisplayEl = getEl('discount-code-display'), orderSummaryEl = getEl('order-summary');
  const backToMenuBtn = getEl('back-to-menu-btn'), copyAccountBtn = getEl('copy-account-btn');
  const slipUploadEl = getEl('slipUpload'), slipPreviewContainerEl = getEl('slip-preview-container');
  const slipPreviewEl = getEl('slip-preview'), uploadSlipBtn = getEl('upload-slip-btn');
  const uploadSlipTextEl = getEl('upload-slip-text'), uploadSlipSpinnerEl = getEl('upload-slip-spinner');
  const finalOrderSummaryEl = getEl('final-order-summary');
  const floatingCartBtnEl = getEl('floating-cart-btn'), openCartPopupBtnEl = getEl('open-cart-popup-btn');
  const cartOverlayEl = getEl('cart-overlay'), closeCartBtnEl = getEl('close-cart-btn');
  const checkoutFromCartBtnEl = getEl('checkout-from-cart-btn');
  const cartSidebarEl = getEl('cart-sidebar');

  window.showMessageBox = (message, color) => {
    const bg = color === 'red' ? 'bg-red-500' : 'bg-gray-800';
    const icon = color === 'red' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle text-emerald-400"></i>';
    const box = document.createElement('div');
    box.className = `fixed top-6 left-1/2 -translate-x-1/2 ${bg} text-white px-6 py-3 rounded-full shadow-xl z-[70] transition-all duration-500 transform translate-y-[-100px] flex items-center gap-3 text-sm font-bold`;
    box.innerHTML = `${icon} <span>${message}</span>`;
    document.body.appendChild(box);
    requestAnimationFrame(()=> box.classList.remove('translate-y-[-100px]'));
    setTimeout(() => {
        box.classList.add('translate-y-[-100px]', 'opacity-0');
        setTimeout(() => box.remove(), 500);
    }, 3000);
  };

  const getOrderQueueNumber = () => {
    const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result=''; for(let i=0;i<4;i++) result+=chars.charAt(Math.floor(Math.random()*chars.length));
    return result;
  };

  async function fetchWithRetry(url, options, retries=3, delay=1000) {
    for(let i=0;i<retries;i++){
      try {
        const res = await fetch(url, options);
        if(res.ok) return res;
        if(res.status >= 500) await new Promise(r=>setTimeout(r, delay*Math.pow(2,i)));
        else throw new Error(`HTTP error! status: ${res.status}`);
      } catch(e){
        if(i<retries-1) await new Promise(r=>setTimeout(r, delay*Math.pow(2,i)));
        else throw e;
      }
    }
  }

  const generateDeliveryDatesForLocation = (locationKey) => {
    const cfg = deliveryConfig[locationKey];
    if (!cfg || !cfg.weekdays || cfg.weekdays.length === 0) return [];
    const dates = [];
    const today = new Date(); today.setHours(0,0,0,0);
    const totalDays = DELIVERY_WEEKS_AHEAD * 7;
    for (let i = 0; i < totalDays; i++) {
      const d = new Date(today); d.setDate(today.getDate() + i);
      if (cfg.weekdays.includes(d.getDay())) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        dates.push(`${yyyy}-${mm}-${dd}`);
      }
    }
    return dates;
  };

  const renderDeliveryDates = (locationKey) => {
    deliveryDatesContainerEl.innerHTML = '';
    if (!locationKey || !deliveryConfig[locationKey]) {
      deliveryDatesContainerEl.innerHTML = '<p class="text-center text-gray-400 text-xs">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô</p>';
      return;
    }
    const now = new Date();
    const cutoffMs = 12 * 60 * 60 * 1000; 
    const availableDateStrings = generateDeliveryDatesForLocation(locationKey);
    const validDates = availableDateStrings.filter(dateString => {
      const deliveryDate = new Date(dateString + 'T00:00:00');
      return (deliveryDate.getTime() - now.getTime()) >= cutoffMs;
    });

    if (validDates.length === 0) {
      deliveryDatesContainerEl.innerHTML = '<p class="text-center text-red-400 text-xs">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 12 ‡∏ä‡∏°.)</p>';
      return;
    }

    validDates.forEach((dateString, idx) => {
      const deliveryDate = new Date(dateString + 'T00:00:00');
      const formattedDate = deliveryDate.toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short' });
      const id = `date-${dateString}`;
      
      deliveryDatesContainerEl.innerHTML += `
        <label for="${id}" class="relative flex items-center justify-between p-3 border border-gray-100 rounded-lg cursor-pointer hover:bg-emerald-50 hover:border-emerald-200 transition-all group">
          <div class="flex items-center gap-3">
             <div class="relative flex items-center justify-center">
                 <input type="checkbox" id="${id}" name="deliveryDate" value="${dateString}" class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-md checked:bg-emerald-500 checked:border-emerald-500 transition-colors">
                 <i class="fas fa-check text-white text-[10px] absolute opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
             </div>
             <span class="text-sm text-gray-700 font-medium group-hover:text-emerald-700">${formattedDate}</span>
          </div>
          <span class="text-[10px] text-emerald-500 bg-emerald-50 px-2 py-0.5 rounded-full hidden peer-checked:inline-block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
        </label>`;
    });
  };

  const renderFloatingCart = () => {
    const isPaymentPage = !paymentSection.classList.contains('hidden');
    if (order.totalItems > 0 && !isPaymentPage) {
      openCartPopupBtnEl.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="relative">
                <span class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-sm">${order.totalItems}</span>
                <i class="fas fa-shopping-basket text-2xl text-emerald-400"></i>
            </div>
            <div class="text-left">
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Total</p>
                <p class="text-lg font-bold leading-none">‡∏ø${order.total.toFixed(0)}</p>
            </div>
        </div>
        <div class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-lg border border-white/10">
            <span class="text-xs font-bold">‡∏î‡∏π‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
            <i class="fas fa-chevron-right text-xs"></i>
        </div>`;
      floatingCartBtnEl.classList.remove('hidden');
    } else {
      floatingCartBtnEl.classList.add('hidden');
    }
  };

  updateTotal = () => {
    let subtotal = 0, totalItems = 0;
    Object.values(order.items).forEach(item => {
      subtotal += item.price * item.quantity;
      totalItems += item.quantity;
    });
    order.subtotal = subtotal;
    order.totalItems = totalItems;

    if(order.discount && (subtotal < order.discount.minSpend || totalItems < order.discount.minItems)) {
      order.discount = null;
      discountInfoEl.textContent = '';
    }

    let discountValue = 0;
    if (order.discount) {
      discountValue = order.discount.type === 'percent' 
        ? (subtotal * order.discount.value) / 100 
        : order.discount.value;
      if (typeof order.discount.maxDiscount === 'number') {
        discountValue = Math.min(discountValue, order.discount.maxDiscount);
      }
    }

    order.total = Math.max(0, subtotal - discountValue);

    if (subtotalPriceEl) subtotalPriceEl.textContent = `‡∏ø${(order.subtotal || 0).toFixed(0)}`;
    if (totalPriceEl) totalPriceEl.textContent = `‡∏ø${(order.total || 0).toFixed(0)}`;

    if (order.discount) {
      discountAmountEl.textContent = `-‡∏ø${discountValue.toFixed(0)}`;
      discountCodeDisplayEl.textContent = order.discount.code;
      discountDisplaySectionEl.classList.remove('hidden');
    } else {
      discountDisplaySectionEl.classList.add('hidden');
    }

    renderFloatingCart();
    if (!cartSidebarEl.classList.contains('hidden')) {
        renderCartSidebarContent();
    }
  };

  const renderMenu = () => {
    menuItemsEl.innerHTML = menu.map(item => {
      // FIXED: Price Range and Ingredients Display
      const minPrice = item.sizes[0].price;
      const maxPrice = item.sizes[item.sizes.length-1].price;
      const priceDisplay = minPrice === maxPrice ? `‡∏ø${minPrice}` : `‡∏ø${minPrice} - ‡∏ø${maxPrice}`;
      
      const bestSellerBadge = item.isBestSeller ? 
         `<div class="absolute top-0 right-0 bg-gradient-to-r from-red-500 to-pink-500 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl z-10 shadow-md badge-shine flex items-center gap-1">
            <i class="fas fa-crown text-yellow-300"></i> Best Seller
          </div>` : '';

      return `
        <div class="menu-card bg-white rounded-2xl p-3 flex gap-3 relative overflow-hidden group">
          ${bestSellerBadge}
          <div class="w-24 h-24 flex-shrink-0 rounded-xl overflow-hidden relative">
            <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
          </div>
          <div class="flex flex-col justify-between flex-1 py-0.5">
            <div>
              <div class="flex justify-between items-start">
                  <h3 class="font-bold text-gray-800 text-lg leading-tight">${item.name}</h3>
              </div>
              <p class="text-xs text-gray-500 mt-1 line-clamp-1"><i class="fas fa-star text-[10px] text-yellow-400"></i> ${item.properties}</p>
              
              <!-- ADDED: Ingredients list back -->
              <p class="text-[10px] text-gray-400 mt-1 truncate"><i class="fas fa-flask text-[10px] text-emerald-400"></i> ${item.ingredients}</p>
            </div>
            
            <div class="flex justify-between items-end mt-2">
              <span class="text-lg font-bold text-emerald-600">${priceDisplay}</span>
              <button onclick="openItemModal('${item.id}')"
                      class="w-8 h-8 flex items-center justify-center rounded-lg text-white bg-emerald-500 hover:bg-emerald-600 shadow-md shadow-emerald-200 transition-all active:scale-90">
                <i class="fas fa-plus text-sm"></i>
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  };

  const renderOrderSummary = (container, data, isFinalSummary) => {
    container.innerHTML = '';
    if (isFinalSummary) {
      const fields = [
        ['Order ID', `<span class="font-mono text-emerald-600">${data.queueNumber}</span>`],
        ['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', data.customerName],
        ['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', data.customerContact.phone],
        ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á', data.deliveryLocationLabel],
        ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á', data.deliveryDates.map(d => d.split('-').slice(1).reverse().join('/')).join(', ')]
      ];
      if (data.customerNote) fields.push(['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', `<span class="text-xs text-gray-500">"${data.customerNote}"</span>`]);
      
      let infoHTML = `<div class="grid grid-cols-2 gap-y-2 mb-4 text-xs text-gray-600">`;
      infoHTML += fields.map(([label, value]) => `
        <div class="col-span-2 sm:col-span-1 flex justify-between sm:block border-b border-dashed border-gray-100 pb-1 sm:border-0">
            <span class="font-bold text-gray-400">${label}</span>
            <span class="text-right sm:text-left sm:block">${value}</span>
        </div>`).join('');
      infoHTML += `</div>`;
      container.innerHTML += infoHTML;
    }

    container.innerHTML += '<h4 class="font-bold text-gray-800 text-xs uppercase tracking-wider mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>';
    const itemsToRender = Array.isArray(data.items) ? data.items : Object.values(data.items);

    container.innerHTML += `<div class="bg-gray-50 rounded-lg p-2 space-y-2 mb-3">`;
    itemsToRender.forEach(item => {
      container.innerHTML += `
        <div class="flex justify-between items-start text-sm">
            <div>
                <span class="font-bold text-gray-700">${item.quantity}x</span> 
                <span class="text-gray-600">${item.name}</span>
                <span class="text-xs text-gray-400">(${item.size})</span>
                ${(item.allergies && item.allergies.length) ? `<div class="text-[10px] text-red-400">‡πÅ‡∏û‡πâ: ${item.allergies.join(',')}</div>` : ''}
            </div>
            <span class="font-bold text-gray-800">‡∏ø${(item.price * item.quantity).toFixed(0)}</span>
        </div>`;
    });
    container.innerHTML += `</div>`;

    if(isFinalSummary) {
      let discountAmount = 0;
      if (data.discount) {
         discountAmount = data.discount.type === 'fixed' ? data.discount.value : (data.subtotal * data.discount.value) / 100;
         if (typeof data.discount.maxDiscount === 'number') discountAmount = Math.min(discountAmount, data.discount.maxDiscount);
      }
      
      container.innerHTML += `
        <div class="border-t pt-2 space-y-1">
            <div class="flex justify-between text-xs text-gray-500">
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span>‡∏ø${data.subtotal.toFixed(0)}</span>
            </div>
            ${data.discount ? `
            <div class="flex justify-between text-xs text-red-500">
                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${data.discount.code})</span><span>-‡∏ø${discountAmount.toFixed(0)}</span>
            </div>` : ''}
            <div class="flex justify-between text-lg font-bold text-emerald-600 mt-2">
                <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>‡∏ø${data.total.toFixed(0)}</span>
            </div>
        </div>`;
    }
  };

  openCartPopupBtnEl.addEventListener('click', openCartSidebar);
  closeCartBtnEl.addEventListener('click', closeCartSidebar);
  cartOverlayEl.addEventListener('click', closeCartSidebar);

  checkoutFromCartBtnEl.addEventListener('click', () => {
    closeCartSidebar();
    renderOrderSummary(orderSummaryEl, { items: Object.values(order.items) }, false);
    updateTotal();
    orderFormSection.classList.add('hidden');
    paymentSection.classList.remove('hidden');
    floatingCartBtnEl.classList.add('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  backToMenuBtn.addEventListener('click', () => {
    paymentSection.classList.add('hidden');
    orderFormSection.classList.remove('hidden');
    renderFloatingCart();
  });

  document.getElementById('modal-overlay').addEventListener('click', closeItemModal);

  applyDiscountBtnEl.addEventListener('click', () => {
    const code = discountCodeInputEl.value.trim().toUpperCase();
    if (!code) return;
    const found = local_discountCodes.find(c => c.code === code);
    const today = new Date(); today.setHours(0,0,0,0);
    const expiry = found ? new Date(found.expiryDate) : null;
    if(expiry) expiry.setHours(23,59,59,999);

    let msg = '', color = 'red';
    if (!found) msg = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ';
    else if (today > expiry) msg = '‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
    else if (order.subtotal < found.minSpend) msg = `‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡∏ø${found.minSpend}`;
    else if (order.totalItems < found.minItems) msg = `‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${found.minItems} ‡∏Ç‡∏ß‡∏î`;
    else { order.discount = found; msg = '‚úÖ ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'; color = 'green'; }

    discountInfoEl.className = `text-xs mb-2 h-4 text-center font-bold ${color === 'green' ? 'text-emerald-500' : 'text-red-500'}`;
    discountInfoEl.textContent = msg;
    if (color === 'red') order.discount = null;
    updateTotal();
  });

  uploadSlipBtn.addEventListener('click', async () => {
    const name = customerNameEl.value.trim();
    const phone = customerPhoneEl.value.trim();
    const note = customerNoteEl.value.trim();
    const locationKey = deliveryLocationEl.value;
    const selectedDates = Array.from(deliveryDatesContainerEl.querySelectorAll('input:checked')).map(node => node.value);
    const slipFile = slipUploadEl.files[0];

    if(!name) return showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö','red');
    if(!/^\d{10}$/.test(phone)) return showMessageBox('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','red');
    if(!locationKey) return showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á','red');
    if(selectedDates.length === 0) return showMessageBox('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á','red');
    if(!slipFile) return showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô','red');

    uploadSlipBtn.disabled = true;
    uploadSlipTextEl.classList.add('hidden');
    uploadSlipSpinnerEl.classList.remove('hidden');

    const finalOrder = {
      queueNumber: getOrderQueueNumber(), customerName: name,
      customerContact: { phone }, customerNote: note,
      deliveryLocationKey: locationKey,
      deliveryLocationLabel: deliveryConfig[locationKey]?.label || '',
      deliveryDates: selectedDates, orderDate: new Date().toISOString(),
      items: Object.values(order.items).filter(i=>i.quantity>0),
      subtotal: order.subtotal, discount: order.discount, total: order.total, totalItems: order.totalItems
    };

    const formData = new FormData();
    formData.append('slipImage', slipFile);
    Object.entries(finalOrder).forEach(([key, value]) => {
      formData.append(key, typeof value === 'object' ? JSON.stringify(value) : value);
    });

    try {
      await fetchWithRetry(n8nWebhookUrl, { method:'POST', body:formData });
      renderOrderSummary(finalOrderSummaryEl, finalOrder, true);
      paymentSection.classList.add('hidden');
      confirmationSection.classList.remove('hidden');
      floatingCartBtnEl.classList.add('hidden');
      window.scrollTo(0,0);
    } catch(err){
      console.error(err);
      showMessageBox('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà','red');
    } finally {
      uploadSlipBtn.disabled = false;
      uploadSlipTextEl.classList.remove('hidden');
      uploadSlipSpinnerEl.classList.add('hidden');
    }
  });

  slipUploadEl.addEventListener('change', e => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = evt => {
        slipPreviewEl.src = evt.target.result;
        slipPreviewContainerEl.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    } else {
      slipPreviewContainerEl.classList.add('hidden');
    }
  });

  // FIXED: Robust Copy to Clipboard function
  copyAccountBtn.addEventListener('click', () => {
    const account = getEl('bank-account-number').textContent.replace(/-/g, '');
    
    // Create temporary textarea
    const textArea = document.createElement("textarea");
    textArea.value = account;
    
    // Make it invisible but part of DOM to satisfy focus requirements
    textArea.style.position = "fixed"; 
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    document.body.appendChild(textArea);
    
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showMessageBox('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß', 'green');
      } else {
        // Fallback
        navigator.clipboard.writeText(account).then(() => {
           showMessageBox('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß', 'green');
        }).catch(() => {
           showMessageBox('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏î‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'red');
        });
      }
    } catch (err) {
      console.error('Copy failed', err);
      showMessageBox('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'red');
    }
    
    document.body.removeChild(textArea);
  });

  deliveryDatesContainerEl.addEventListener('change', () => {
    const selectedCount = deliveryDatesContainerEl.querySelectorAll('input:checked').length;
    deliveryWarningEl.classList.toggle('hidden', selectedCount <= 1);
  });

  deliveryLocationEl.addEventListener('change', () => {
    const key = deliveryLocationEl.value;
    renderDeliveryDates(key);
  });

  renderMenu();
  updateTotal();
  renderDeliveryDates();
});
</script>
</body>
</html>
