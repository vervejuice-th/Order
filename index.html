<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verve Juice Order</title>

  <!-- Tailwind & Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Inter:wght@400;700&family=Rubik+Bubbles&family=Noto+Sans+Thai:wght@400;700&display=swap');

    body {
      font-family: 'Noto Sans Thai', sans-serif;
      background: linear-gradient(135deg, #86efac, #fde047);
    }
    .cute-font { font-family: 'Kanit', sans-serif; }
    .container { max-width: 90%; margin-top: 1rem; margin-bottom: 1rem; padding-bottom: 100px; }
    .card { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06); }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 24px; height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }

    /* Modal */
    .modal-overlay { transition: opacity 0.3s ease; }
    .modal-content { transition: transform 0.3s ease; }

    /* Cart Sidebar Transitions */
    #cart-sidebar.open #cart-overlay { opacity: 1; }
    /* UPDATED: transform: translateY(0) */
    #cart-sidebar.open #cart-content { transform: translateY(0); }
    #cart-overlay { opacity: 0; transition: opacity 0.3s ease-in-out; }
    #cart-content { transition: transform 0.3s ease-in-out; }

    /* ===== Floating LINE OA (‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏à‡∏≠) ===== */
    .line-float-side {
      position: fixed;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 9999;
    }

    .line-float-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(16, 185, 129, 0.35);
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .line-float-btn:hover {
      transform: scale(1.03);
      box-shadow: 0 14px 38px rgba(0,0,0,0.22);
    }

    .line-float-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.35);
      font-size: 22px;
      color: #16a34a;
      flex: 0 0 auto;
    }

    .line-float-text {
      display: flex;
      flex-direction: column;
      line-height: 1.05;
      color: #111827;
      white-space: nowrap;
    }

    .line-float-title {
      font-weight: 800;
      font-size: 12px;
    }

    .line-float-sub {
      font-size: 11px;
      color: #4b5563;
      margin-top: 2px;
    }

    /* Bubble (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÅ‡∏ï‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡πâ‡∏≤‡∏¢ 2 ‡∏ß‡∏¥) */
    .line-oa-bubble {
      position: absolute;
      right: 56px; /* ‡∏≠‡∏¢‡∏π‡πà‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° */
      top: 50%;
      transform: translateY(-50%) scale(0.98);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(16, 185, 129, 0.25);
      box-shadow: 0 10px 26px rgba(0,0,0,0.16);
      border-radius: 14px;
      padding: 10px 12px;
      min-width: 190px;
      max-width: 230px;
    }
    .line-oa-bubble.show {
      opacity: 1;
      transform: translateY(-50%) scale(1);
    }
    .line-oa-bubble:after {
      content: "";
      position: absolute;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 8px solid rgba(255,255,255,0.96);
      filter: drop-shadow(0 0 1px rgba(16,185,129,0.25));
    }
    .line-oa-bubble-title { font-weight: 800; font-size: 12px; color: #111827; }
    .line-oa-bubble-sub { font-size: 11px; color: #4b5563; margin-top: 2px; line-height: 1.15; }
    .line-oa-bubble-cta { font-size: 11px; color: #16a34a; font-weight: 700; margin-top: 6px; }

    /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡∏ö‡∏±‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° -> ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å + ‡πÅ‡∏ï‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡πâ‡∏≤‡∏¢ 2 ‡∏ß‡∏¥ */
    @media (max-width: 480px) {
      .line-float-side {
        right: 12px;
        top: auto;
        bottom: 120px; /* ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á input + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        transform: none;
      }

      .line-float-btn {
        gap: 0;
        padding: 10px;
        border-radius: 999px;
      }

      .line-float-text {
        display: none; /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß */
      }

      .line-float-icon {
        width: 44px;
        height: 44px;
        font-size: 24px;
      }

      /* ‡∏ã‡πà‡∏≠‡∏ô soft hint ‡πÉ‡∏ï‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      #line-oa-float .line-soft-hint {
        display: none;
      }
    }

    /* ===== Edge-only Drag LINE OA (‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö) ===== */
#line-oa-float{
  touch-action: none; /* ‡∏Å‡∏±‡∏ô scroll ‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å */
}
#line-oa-float.is-dragging{
  user-select: none;
  cursor: grabbing;
}
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<div class="container bg-white/30 backdrop-blur-xl p-6 rounded-3xl shadow-2xl w-full max-w-lg transition-all duration-300">

  <!-- Order Form Section -->
  <div id="order-form-section">
    <div class="flex justify-center mb-3">
      <img src="https://github.com/kornkawes/VerveImage/blob/main/logo2.png?raw=true"
           alt="Verve Juice Logo" class="w-48" />
    </div>

    <!-- Social -->
    <div class="flex justify-center space-x-6 mb-6 text-2xl text-gray-800">
      <a href="https://www.tiktok.com/@vervejuice.th" class="hover:text-emerald-600" target="_blank" aria-label="TikTok">
        <i class="fa-brands fa-tiktok"></i>
      </a>
      <a href="https://www.instagram.com/vervejuice.th" class="hover:text-emerald-600" target="_blank" aria-label="Instagram">
        <i class="fa-brands fa-instagram"></i>
      </a>
    </div>

    <!-- NEW: Announcement Box -->
    <div class="mb-6 p-4 bg-white/80 rounded-2xl border border-emerald-200 text-sm text-gray-800 space-y-3">
      <div>
        <p class="font-bold text-center text-emerald-700">üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á üìç</p>
        <p class="text-center">‡∏™‡∏≤‡∏ó‡∏£ / ‡∏ï‡∏∂‡∏Å Park Silom</p>
        <p class="text-center">‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢ / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ß‡∏ô‡∏ä‡∏°</p>
        <p class="text-center text-xs text-gray-600">(‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö)</p>
      </div>
      <hr class="border-dashed border-emerald-200">
      <div>
        <p class="font-bold text-center text-emerald-700">üçπ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® üçπ</p>
        <p class="text-center">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ Verve Juice ‡∏°‡∏µ Line Official Account ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡πâ‡∏≤ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 10% ‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏öüéâ</p>
      </div>
    </div>

    <h2 class="text-2xl font-bold mb-4" style="color:#39531a;">‡πÄ‡∏°‡∏ô‡∏π</h2>
    <div id="menu-items" class="space-y-4"></div>
  </div>

  <!-- Payment Section -->
  <div id="payment-section" class="hidden">
    <h1 class="text-3xl font-bold text-center mb-2" style="color:#39531a;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h1>
    <button id="back-to-menu-btn"
            class="mb-4 px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition-colors">
      <i class="fas fa-arrow-left mr-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π
    </button>

    <h2 class="text-2xl font-bold my-4" style="color:#39531a;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h2>
    <div class="space-y-4">
      <div>
        <label for="customerName" class="block text-gray-700 font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì*</label>
        <input id="customerName" type="text" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
               class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
      </div>
      <div>
        <label for="customerPhone" class="block text-gray-700 font-bold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå*</label>
        <input id="customerPhone" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (10 ‡∏´‡∏•‡∏±‡∏Å)"
               class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
      </div>

      <!-- NEW: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô -->
      <div>
        <label for="deliveryLocation" class="block text-gray-700 font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á*</label>

            <p class="text-xs text-red-600 mt-1">
                ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà Line OA ‡∏Ñ‡∏£‡∏±‡∏ö
            </p>

        <select id="deliveryLocation"
                class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300 bg-white">
          <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á --</option>
          <option value="sathorn">‡∏™‡∏≤‡∏ó‡∏£ / ‡∏ï‡∏∂‡∏Å Park Silom</option>
          <option value="sainoi">‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢ / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ß‡∏ô‡∏ä‡∏°</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á*</label>
        <div id="delivery-dates-container" class="space-y-2 p-3 bg-white rounded-xl border text-sm text-gray-600">
          <p class="text-center text-gray-400">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô</p>
        </div>
        <p id="delivery-warning" class="text-xs text-red-600 mt-2 hidden">(‡∏Ç‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á)</p>
      </div>
      <div>
        <label for="customerNote" class="block text-gray-700 font-bold mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="customerNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ grab/lineman ‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏™‡∏≤‡∏ó‡∏£/‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢"
                  class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300 resize-none h-24"></textarea>
      </div>
    </div>

    <hr class="my-6 border-gray-300">

    <div id="order-summary" class="p-4 bg-gray-50 rounded-2xl mb-4">
      <h3 class="text-xl font-bold mb-2" style="color:#39531a;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
    </div>

    <div class="mt-4">
      <label for="discountCode" class="block text-gray-700 font-bold mb-2">‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
      <div class="flex space-x-2">
        <input id="discountCode" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î"
               class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
        <button id="apply-discount-btn"
                class="px-4 py-2 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-700 transition-colors">
          ‡πÉ‡∏ä‡πâ
        </button>
      </div>
      <p id="discount-info" class="text-sm mt-2 h-5"></p>
    </div>

    <div id="total-summary-section" class="mt-4 p-4 bg-emerald-100 rounded-2xl space-y-2">
      <div class="flex justify-between items-center text-gray-700">
        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span id="subtotal-price">‡∏ø0</span>
      </div>
      <div id="discount-display-section" class="flex justify-between items-center text-red-500 hidden">
        <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (<span id="discount-code-display"></span>)</span>
        <span id="discount-amount">-‡∏ø0</span>
      </div>
      <div class="flex justify-between items-center text-gray-800 border-t pt-2 mt-2">
        <span class="text-lg font-bold">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
        <span id="total-price" class="text-2xl font-extrabold text-emerald-600">‡∏ø0</span>
      </div>
    </div>

    <hr class="my-6 border-gray-300">

    <h3 class="text-xl font-bold mb-2" style="color:#39531a;">‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <div class="space-y-4">
      <div class="bg-gray-50 p-4 rounded-2xl flex flex-col items-center">
        <p class="font-bold mb-2">‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô QR Code</p>
        <div id="qr-display-container"
             class="w-48 h-48 border border-gray-200 rounded-xl flex items-center justify-center bg-gray-100">
          <img id="qrCodeImage"
               src="https://github.com/kornkawes/Image/blob/main/unnamed%20(1).jpg?raw=true"
               alt="QR Code"
               class="w-full h-full object-contain rounded-xl"
               onerror="this.onerror=null;this.src='https://placehold.co/400x400/eeeeee/333333?text=QR+Code';showMessageBox('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ','red');">
        </div>
        <p class="text-sm text-gray-500 mt-2">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-2xl">
        <p class="font-bold mb-1">‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>
        <div class="bg-gray-100 p-3 rounded-xl flex items-center justify-between">
          <div class="flex-1 text-sm">
            <p>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô‡∏≤‡∏¢ ‡∏Å‡∏£‡∏Å‡∏ß‡∏µ ‡∏™‡∏≤‡∏¢‡πÄ‡∏û‡∏ä‡∏£</p>
            <p>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</p>
            <p class="font-bold" id="bank-account-number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: 014-1-08305-8</p>
          </div>
          <button id="copy-account-btn"
                  class="ml-4 px-3 py-1 bg-gray-200 text-gray-700 text-sm font-bold rounded-lg hover:bg-gray-300 transition-colors">
            ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
          </button>
        </div>
      </div>
    </div>

    <div class="mt-6">
      <label for="slipUpload" class="block text-gray-700 font-bold mb-2">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô*</label>
      <input id="slipUpload" type="file" accept="image/*"
             class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300" />
    </div>
    <div id="slip-preview-container" class="hidden mt-4 p-4 border rounded-xl bg-gray-50 flex flex-col items-center">
      <p class="text-sm text-gray-600 mb-2">‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</p>
      <img id="slip-preview" src="#" alt="Slip Preview"
           class="max-w-xs max-h-40 rounded-lg object-contain border border-gray-300" />
    </div>
    <button id="upload-slip-btn"
            class="w-full mt-6 bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-emerald-700 transition-colors flex items-center justify-center">
      <span id="upload-slip-text">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
      <div id="upload-slip-spinner" class="spinner hidden ml-2"></div>
    </button>
  </div>

  <!-- Confirmation Section -->
  <div id="confirmation-section" class="hidden text-center">
    <svg class="mx-auto h-16 w-16 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <h1 class="text-3xl font-bold text-center mt-4 text-emerald-600 cute-font">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠!</h1>
    <p class="mt-2 text-gray-600">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</p>
    <p class="text-center text-red-600 text-xs mb-4">(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)</p>
    <div id="final-order-summary" class="mt-6 text-left p-4 bg-gray-50 rounded-2xl border border-emerald-200"></div>
    <button onclick="window.location.reload()"
            class="mt-6 bg-gray-400 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-gray-500 transition-colors">
      ‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
    </button>
  </div>
</div>

<!-- Item Selection Modal -->
<div id="item-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
  <div id="modal-overlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
  <div id="modal-content" class="modal-content bg-white rounded-2xl shadow-xl p-6 w-11/12 max-w-sm transform scale-95">
    <!-- Content injected by JS -->
  </div>
</div>

<!-- Cart Sidebar -->
<div id="cart-sidebar" class="fixed inset-0 z-50 flex items-end hidden">
  <!-- Overlay -->
  <div id="cart-overlay" class="absolute inset-0 bg-black bg-opacity-30"></div>
  <!-- Content -->
  <div id="cart-content" class="relative w-full max-w-lg mx-auto bg-white max-h-[90vh] shadow-xl transform translate-y-full flex flex-col rounded-t-2xl">
    <!-- Header -->
    <div class="flex-shrink-0 p-4 border-b sticky top-0 bg-white z-10 rounded-t-2xl">
      <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
      <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold" style="color:#39531a;">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
        <button id="close-cart-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      </div>
    </div>
    <!-- Item List -->
    <div id="cart-items-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
    <!-- Footer -->
    <div class="flex-shrink-0 p-4 border-t bg-gray-50 sticky bottom-0 z-10">
      <div class="flex justify-between items-center text-lg">
        <span class="font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
        <span id="cart-subtotal" class="font-extrabold text-xl text-emerald-600">‡∏ø0</span>
      </div>
      <button id="checkout-from-cart-btn" class="w-full mt-4 bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-emerald-700 transition-colors">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      </button>
    </div>
  </div>
</div>

<!-- Floating Cart Button -->
<div id="floating-cart-btn" class="fixed bottom-0 left-0 right-0 z-40 p-4 hidden">
  <button id="open-cart-popup-btn"
          class="w-full max-w-lg mx-auto bg-emerald-600 text-white font-bold py-3 px-4 rounded-2xl shadow-lg hover:bg-emerald-700 transition-transform hover:scale-105 flex justify-between items-center">
  </button>
</div>

<!-- Floating LINE OA Button (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤) -->
<div id="line-oa-float" class="line-float-side" aria-label="LINE OA Floating Button">
  <!-- bubble ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡πÅ‡∏ï‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 2 ‡∏ß‡∏¥) -->
  <div id="line-oa-bubble" class="line-oa-bubble" role="status" aria-live="polite">
    <div class="line-oa-bubble-title">‡∏ó‡∏±‡∏Å LINE ‡∏£‡πâ‡∏≤‡∏ô Verve Juice</div>
    <div class="line-oa-bubble-sub">‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‚Ä¢ ‡∏™‡∏±‡πà‡∏á‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‚Ä¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á</div>
    <div class="line-oa-bubble-cta">‡πÅ‡∏ï‡∏∞‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î LINE</div>
  </div>

  <a id="line-oa-link"
     class="line-float-btn"
     href="https://lin.ee/Z5hDNAQ"
     target="_blank"
     rel="noopener"
     title="‡∏ó‡∏±‡∏Å LINE ‡∏£‡πâ‡∏≤‡∏ô Verve Juice">
    <div class="line-float-icon">
      <i class="fa-brands fa-line"></i>
    </div>
    <div class="line-float-text">
      <div class="line-float-title">‡∏ó‡∏±‡∏Å LINE ‡∏£‡πâ‡∏≤‡∏ô</div>
      <div class="line-float-sub">‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° / ‡∏™‡∏±‡πà‡∏á / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á</div>
    </div>
  </a>

  <!-- Soft hint (‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ‡πÄ‡∏´‡πá‡∏ô / ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô) -->
  <div class="line-soft-hint mt-2 text-[11px] text-gray-500 text-center leading-snug">
    * ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
  </div>
</div>

<script>
window.getEl = id => document.getElementById(id);

// --- GLOBAL STATE ---
let order = { items:{}, total:0, subtotal:0, discount:null, totalItems:0 };
let menu = [];
let updateTotal = () => {};
let renderCartSidebarContent = () => {};

// ===== MODAL (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π/‡πÅ‡∏û‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°) =====
window.changeModalQty = (inputId, change) => {
  const qtyInput = getEl(inputId);
  let currentQty = parseInt(qtyInput.value);
  let newQty = Math.max(1, currentQty + change);
  qtyInput.value = newQty;
};

window.openItemModal = (id) => {
  const item = menu.find(i => i.id === id);
  const modalContentEl = getEl('modal-content');

  const allergyOptionsHtml = item.ingredients.split(',').map(ing => {
    const trimmed = ing.trim();
    return `<label class="flex items-center space-x-2 text-sm">
              <input type="checkbox" name="modal-allergy-${id}" value="${trimmed}" class="form-checkbox h-4 w-4 text-emerald-500 rounded">
              <span>${trimmed}</span>
            </label>`;
  }).join('');

  const sizeOptionsHtml = item.sizes.map(size => {
    return `<option value="${size.size}" data-price="${size.price}">
              ${size.size} - ‡∏ø${size.price}
            </option>`;
  }).join('');

  modalContentEl.innerHTML = `
    <h3 class="text-2xl font-bold mb-4 text-center">${item.name}</h3>
    <div class="space-y-4">
      <div>
        <label for="modal-size-select" class="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î</label>
        <select id="modal-size-select" class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-300 bg-white">
          ${sizeOptionsHtml}
        </select>
      </div>
      <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
        <p class="font-bold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
        <div class="flex items-center space-x-2">
          <button onclick="changeModalQty('modal-qty-input', -1)" class="w-8 h-8 rounded-full bg-emerald-400 text-white font-bold">-</button>
          <input type="number" id="modal-qty-input" class="w-12 text-center font-bold bg-transparent" value="1" readonly>
          <button onclick="changeModalQty('modal-qty-input', 1)" class="w-8 h-8 rounded-full bg-emerald-600 text-white font-bold">+</button>
        </div>
      </div>
    </div>
    <div class="mt-4">
      <label class="flex items-center space-x-2 cursor-pointer font-semibold">
        <input type="checkbox" onchange="getEl('allergy-options-${id}').classList.toggle('hidden')" class="form-checkbox h-4 w-4 text-emerald-600 rounded">
        <span>‡πÅ‡∏à‡πâ‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ</span>
      </label>
      <div id="allergy-options-${id}" class="mt-2 p-2 border rounded-lg bg-white hidden space-y-1">
        ${allergyOptionsHtml}
        <p class="pt-1 border-t text-xs text-red-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡∏≠‡∏≤‡∏à‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏Å‡∏ï‡∏¥</p>
      </div>
    </div>
    <button onclick="confirmItemSelection('${id}')" class="w-full mt-6 bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>`;

  getEl('item-modal').classList.remove('hidden');
  getEl('modal-overlay').classList.add('opacity-100');
  modalContentEl.classList.add('scale-100');
};

window.confirmItemSelection = (id) => {
  const modalContentEl = getEl('modal-content');
  const sizeSelectEl = getEl('modal-size-select');
  const selectedOption = sizeSelectEl.options[sizeSelectEl.selectedIndex];
  const size = selectedOption.value;
  const price = parseFloat(selectedOption.dataset.price);
  const quantity = parseInt(getEl('modal-qty-input').value);
  if (quantity <= 0) return closeItemModal();

  const allergyNodes = modalContentEl.querySelectorAll(`input[name="modal-allergy-${id}"]:checked`);
  const allergies = Array.from(allergyNodes).map(node => node.value).sort();
  const allergyKey = allergies.length > 0 ? allergies.join(',') : 'none';
  const compositeId = `${id}-${size}-${allergyKey}`;

  if (order.items[compositeId]) {
    order.items[compositeId].quantity += quantity;
  } else {
    const itemData = menu.find(i => i.id === id);
    order.items[compositeId] = {
      id: id, name: itemData.name, size: size,
      price: price, quantity: quantity, allergies: allergies
    };
  }

  updateTotal();
  closeItemModal();
};

window.closeItemModal = () => {
  const itemModalEl = getEl('item-modal');
  const modalOverlayEl = getEl('modal-overlay');
  const modalContentEl = getEl('modal-content');
  modalOverlayEl.classList.remove('opacity-100');
  modalContentEl.classList.remove('scale-100');
  setTimeout(() => { itemModalEl.classList.add('hidden'); modalContentEl.innerHTML = ''; }, 300);
};

window.adjustItem = (menuId, size, allergyKey, delta) => {
  const key = `${menuId}-${size}-${allergyKey}`;
  if (!order.items[key]) return;
  order.items[key].quantity += delta;
  if (order.items[key].quantity <= 0) delete order.items[key];
  updateTotal();
};

window.openCartSidebar = () => {
  renderCartSidebarContent();
  const sidebar = getEl('cart-sidebar');
  sidebar.classList.remove('hidden');
  setTimeout(() => sidebar.classList.add('open'), 10);
};

window.closeCartSidebar = () => {
  const sidebar = getEl('cart-sidebar');
  sidebar.classList.remove('open');
  setTimeout(() => sidebar.classList.add('hidden'), 300);
};

renderCartSidebarContent = () => {
  const listEl = getEl('cart-items-list');
  const subtotalEl = getEl('cart-subtotal');
  listEl.innerHTML = '';

  if (order.totalItems === 0) {
    listEl.innerHTML = '<p class="text-center text-gray-500">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
  } else {
    const itemsToRender = Object.values(order.items).sort((a,b) => a.name.localeCompare(b.name));
    itemsToRender.forEach(item => {
      if (item.quantity <= 0) return;
      const allergyKey = (item.allergies && item.allergies.length) ? item.allergies.join(',') : 'none';
      const safeAllergyKey = allergyKey.replace(/'/g, "\\'");
      const itemData = menu.find(i => i.id === item.id);

      listEl.innerHTML += `
        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg border">
          <img src="${itemData.imageUrl}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0">
          <div class="flex-1 min-w-0">
            <p class="font-bold text-gray-800 truncate">${item.name}</p>
            <p class="text-sm text-gray-600">${item.size}</p>
            <p class="text-sm text-emerald-600 font-semibold">‡∏ø${item.price.toFixed(2)}</p>
            ${item.allergies.length > 0 ? `<p class="text-xs text-red-500">‡πÅ‡∏û‡πâ: ${item.allergies.join(', ')}</p>` : ''}
          </div>
          <div class="flex flex-col items-end space-y-2">
             <div class="flex items-center space-x-2">
              <button class="w-7 h-7 rounded-full bg-emerald-100 text-emerald-700 font-bold"
                      onclick="adjustItem('${item.id}','${item.size}','${safeAllergyKey}', -1)">‚Äì</button>
              <span class="w-8 text-center font-bold">${item.quantity}</span>
              <button class="w-7 h-7 rounded-full bg-emerald-600 text-white font-bold"
                      onclick="adjustItem('${item.id}','${item.size}','${safeAllergyKey}', 1)">+</button>
            </div>
            <span class="text-base font-bold text-gray-800">‡∏ø${(item.price * item.quantity).toFixed(2)}</span>
          </div>
        </div>
      `;
    });
  }
  subtotalEl.textContent = `‡∏ø${order.subtotal.toFixed(2)}`;
};

document.addEventListener('DOMContentLoaded', () => {
  // ===== LINE OA: ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡πâ‡∏≤‡∏¢ 2 ‡∏ß‡∏¥ (‡πÅ‡∏ï‡∏∞‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡∏¥‡∏î LINE) =====
  const lineLink = getEl('line-oa-link');
  const lineBubble = getEl('line-oa-bubble');
  let bubbleTimer = null;
  let armedToOpen = false;

  const isMobile = () => window.matchMedia('(max-width: 480px)').matches;

  const showLineBubble = () => {
    if (!lineBubble) return;
    lineBubble.classList.add('show');
    armedToOpen = true;

    clearTimeout(bubbleTimer);
    bubbleTimer = setTimeout(() => {
      lineBubble.classList.remove('show');
      armedToOpen = false;
    }, 2000);
  };

    // ===== Long-Press Edge Drag LINE OA (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ) =====
const lineFloat = getEl('line-oa-float');

if (lineFloat) {
  lineFloat.style.right = 'auto';
  lineFloat.style.bottom = 'auto';
  lineFloat.style.top = 'auto';

  const GAP = 8;
  const LONG_PRESS_MS = 400; // ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡πâ‡∏≤‡∏¢
  const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
  const pickEdge = (x) => (x < window.innerWidth / 2 ? 'left' : 'right');

  const applyEdgeY = (edge, y) => {
    const rect = lineFloat.getBoundingClientRect();
    const maxY = window.innerHeight - rect.height - GAP;
    const top = clamp(y, GAP, maxY);
    const left =
      edge === 'left'
        ? GAP
        : window.innerWidth - rect.width - GAP;

    lineFloat.style.left = `${left}px`;
    lineFloat.style.top = `${top}px`;
    return { edge, y: top };
  };

  // restore saved position
  try {
    const saved = JSON.parse(localStorage.getItem('lineOA_pos') || 'null');
    if (saved?.edge) {
      requestAnimationFrame(() => applyEdgeY(saved.edge, saved.y));
    } else {
      requestAnimationFrame(() =>
        applyEdgeY('right', window.innerHeight - 180)
      );
    }
  } catch {
    requestAnimationFrame(() =>
      applyEdgeY('right', window.innerHeight - 180)
    );
  }

  let pressTimer = null;
  let dragging = false;
  let startY = 0;
  let baseTop = 0;
  let edge = 'right';

  lineFloat.addEventListener('pointerdown', (e) => {
    dragging = false;
    startY = e.clientY;
    baseTop = lineFloat.getBoundingClientRect().top;
    edge = pickEdge(e.clientX);

    // üëâ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö long-press
    pressTimer = setTimeout(() => {
      dragging = true;
      lineFloat.classList.add('is-dragging');
      lineFloat.setPointerCapture?.(e.pointerId);
    }, LONG_PRESS_MS);
  });

  window.addEventListener('pointermove', (e) => {
    if (!dragging) return;

    e.preventDefault();
    const dy = e.clientY - startY;
    applyEdgeY(edge, baseTop + dy);
  }, { passive: false });

  window.addEventListener('pointerup', () => {
    clearTimeout(pressTimer);

    if (dragging) {
      const rect = lineFloat.getBoundingClientRect();
      const finalEdge = pickEdge(rect.left + rect.width / 2);
      const pos = applyEdgeY(finalEdge, rect.top);

      localStorage.setItem(
        'lineOA_pos',
        JSON.stringify({ edge: pos.edge, y: pos.y })
      );
    }

    dragging = false;
    lineFloat.classList.remove('is-dragging');
  });

  window.addEventListener('resize', () => {
    const rect = lineFloat.getBoundingClientRect();
    const finalEdge = pickEdge(rect.left + rect.width / 2);
    const pos = applyEdgeY(finalEdge, rect.top);
    localStorage.setItem('lineOA_pos', JSON.stringify(pos));
  });
}

  if (lineLink) {
    lineLink.addEventListener('click', (e) => {
      // Desktop: ‡πÄ‡∏õ‡∏¥‡∏î LINE ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      if (!isMobile()) return;

      // ‡∏Å‡∏±‡∏ô ‚Äú‡∏•‡∏≤‡∏Å‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ trigger bubble/‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå
      const floatEl = getEl('line-oa-float');
      if (floatEl && floatEl.classList.contains('is-dragging')) {
        e.preventDefault();
        return;
      }

      // Mobile: tap ‡πÅ‡∏£‡∏Å‡πÇ‡∏ä‡∏ß‡πå bubble 2 ‡∏ß‡∏¥ + ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡πá‡∏ö
      if (!armedToOpen) {
        e.preventDefault();
        showLineBubble();
        return;
      }
      // tap ‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 2 ‡∏ß‡∏¥ -> ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î LINE ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    }, { passive: false });
  }

  // CONFIG: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á + ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÑ‡∏õ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ
  // getDay() ‡∏Ç‡∏≠‡∏á JS: 0=‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå, 1=‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå, 2=‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£, 3=‡∏û‡∏∏‡∏ò, 4=‡∏û‡∏§‡∏´‡∏±‡∏™, 5=‡∏®‡∏∏‡∏Å‡∏£‡πå, 6=‡πÄ‡∏™‡∏≤‡∏£‡πå
  const deliveryConfig = {
    sathorn: {
      label: '‡∏™‡∏≤‡∏ó‡∏£ / ‡∏ï‡∏∂‡∏Å Park Silom',
      weekdays: [1, 2, 3] // ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏û‡∏∏‡∏ò
    },
    sainoi: {
      label: '‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢ / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ß‡∏ô‡∏ä‡∏°',
      weekdays: [1, 2, 3, 4, 5] // ‡∏û‡∏§‡∏´‡∏±‡∏™-‡∏®‡∏∏‡∏Å‡∏£‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á)
    }
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏° key ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô:
    // otherArea: { label: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô', weekdays: [2,5] }
  };

  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô ‚Äú‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‚Äù ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
  const DELIVERY_WEEKS_AHEAD = 1;

  const local_menu = [
    { id:'apple-kiss',   name:'Apple Kiss',   ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏Ç‡∏¥‡∏á, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ú‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î, ‡∏•‡∏î‡∏à‡∏∏‡∏î‡∏î‡πà‡∏≤‡∏á‡∏î‡∏≥, ‡∏£‡∏≠‡∏¢‡∏™‡∏¥‡∏ß', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/apple%20kiss.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'blush-bloom',  name:'Blush Bloom',  ingredients:'‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®, ‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏ä‡πà‡∏ß‡∏¢‡∏ú‡∏•‡∏±‡∏î‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ú‡∏¥‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏£‡∏¥‡πâ‡∏ß‡∏£‡∏≠‡∏¢', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/blush%20bloom.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'Pure-guava',  name:'Pure Guava',  ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏ù‡∏£‡∏±‡πà‡∏á, ‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©, ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å, ‡∏ó‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡∏î, ‡∏à‡∏∏‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡πÅ‡∏ô‡πà‡∏ô‡∏ó‡πâ‡∏≠‡∏á', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/lime%20guava.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'hearty-green', name:'Hearty Green', ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î, ‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', properties:'‡∏•‡∏î‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/hearty%20green.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'sweet-detox',  name:'Sweet Detox',  ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó, ‡∏ö‡∏µ‡∏ó‡∏£‡∏π‡∏ó', properties:'‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å, ‡∏ï‡πâ‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏π‡∏•‡∏≠‡∏¥‡∏™‡∏£‡∏∞', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/sweet%20detox.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'beet-love',    name:'Beet Love',    ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡∏ö‡∏µ‡∏ó‡∏£‡∏π‡∏ó, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/beet%20love.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'smart-sip',    name:'Smart Sip',    ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡πÄ‡∏Ñ‡∏•, ‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', properties:'‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏™‡∏≤‡∏¢‡∏ï‡∏≤', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/smart%20sip.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
    { id:'recharge-me',  name:'Recharge Me',  ingredients:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•, ‡∏Ç‡∏¥‡∏á, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', properties:'‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏•‡πâ‡∏≤', imageUrl:'https://github.com/kornkawes/VerveImage/blob/main/recharge%20me.jpg?raw=true', sizes: [{size:'250ml', price:89}, {size:'300ml', price:109}]},
  ];
  const local_discountCodes = [
    { code:"VJLINE10", type:"percent", value:10, expiryDate:"2025-12-31", minSpend:0, minItems:3, maxDiscount:40 },
    { code:"VERVETIKTOK", type:"fixed", value:20, expiryDate:"2025-12-31", minSpend:0, minItems:3, maxDiscount:20 }
  ];
  const n8nWebhookUrl = "https://n8n-verve-u61532.vm.elestio.app/webhook/3292a5c3-0f7f-424f-92f8-7dc42f51d763";

  menu = local_menu;

  const orderFormSection = getEl('order-form-section'), paymentSection = getEl('payment-section');
  const confirmationSection = getEl('confirmation-section'), menuItemsEl = getEl('menu-items');
  const customerNameEl = getEl('customerName'), customerPhoneEl = getEl('customerPhone');
  const customerNoteEl = getEl('customerNote'),
        deliveryLocationEl = getEl('deliveryLocation'),
        deliveryDatesContainerEl = getEl('delivery-dates-container');
  const deliveryWarningEl = getEl('delivery-warning'), discountCodeInputEl = getEl('discountCode');
  const applyDiscountBtnEl = getEl('apply-discount-btn'), discountInfoEl = getEl('discount-info');
  const subtotalPriceEl = getEl('subtotal-price'), discountAmountEl = getEl('discount-amount');
  const totalPriceEl = getEl('total-price'), discountDisplaySectionEl = getEl('discount-display-section');
  const discountCodeDisplayEl = getEl('discount-code-display'), orderSummaryEl = getEl('order-summary');
  const backToMenuBtn = getEl('back-to-menu-btn'), copyAccountBtn = getEl('copy-account-btn');
  const slipUploadEl = getEl('slipUpload'), slipPreviewContainerEl = getEl('slip-preview-container');
  const slipPreviewEl = getEl('slip-preview'), uploadSlipBtn = getEl('upload-slip-btn');
  const uploadSlipTextEl = getEl('upload-slip-text'), uploadSlipSpinnerEl = getEl('upload-slip-spinner');
  const finalOrderSummaryEl = getEl('final-order-summary');
  const itemModalEl = getEl('item-modal'), modalOverlayEl = getEl('modal-overlay');
  const floatingCartBtnEl = getEl('floating-cart-btn');
  const openCartPopupBtnEl = getEl('open-cart-popup-btn');
  const cartSidebarEl = getEl('cart-sidebar');
  const cartOverlayEl = getEl('cart-overlay');
  const closeCartBtnEl = getEl('close-cart-btn');
  const checkoutFromCartBtnEl = getEl('checkout-from-cart-btn');

  window.showMessageBox = (message, color) => {
    const colorMap = { red:'bg-red-500', green:'bg-green-500' };
    const box = document.createElement('div');
    box.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 ${colorMap[color] || 'bg-gray-500'} text-white px-6 py-4 rounded-xl shadow-lg z-50 transition-all duration-300`;
    box.textContent = message;
    document.body.appendChild(box);
    setTimeout(() => box.remove(), 3000);
  };

  const getOrderQueueNumber = () => {
    const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result=''; for(let i=0;i<4;i++) result+=chars.charAt(Math.floor(Math.random()*chars.length));
    return result;
  };

  async function fetchWithRetry(url, options, retries=3, delay=1000) {
    for(let i=0;i<retries;i++){
      try {
        const res = await fetch(url, options);
        if(res.ok) return res;
        if(res.status >= 500) await new Promise(r=>setTimeout(r, delay*Math.pow(2,i)));
        else throw new Error(`HTTP error! status: ${res.status}`);
      } catch(e){
        if(i<retries-1) await new Promise(r=>setTimeout(r, delay*Math.pow(2,i)));
        else throw e;
      }
    }
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á list ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏à‡∏≤‡∏Å config + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
  const generateDeliveryDatesForLocation = (locationKey) => {
    const cfg = deliveryConfig[locationKey];
    if (!cfg || !cfg.weekdays || cfg.weekdays.length === 0) return [];

    const dates = [];
    const today = new Date();
    today.setHours(0,0,0,0);
    const totalDays = DELIVERY_WEEKS_AHEAD * 7;

    for (let i = 0; i < totalDays; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() + i);
      const dow = d.getDay(); // 0-6
      if (cfg.weekdays.includes(dow)) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        dates.push(`${yyyy}-${mm}-${dd}`);
      }
    }
    return dates;
  };

  const renderDeliveryDates = (locationKey) => {
    deliveryDatesContainerEl.innerHTML = '';

    if (!locationKey || !deliveryConfig[locationKey]) {
      deliveryDatesContainerEl.innerHTML = '<p class="text-center text-gray-400 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô</p>';
      return;
    }

    const now = new Date();
    const cutoffHours = 12; // ‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 12 ‡∏ä‡∏°. (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    const cutoffMs = cutoffHours * 60 * 60 * 1000;

    const availableDateStrings = generateDeliveryDatesForLocation(locationKey);

    const validDates = availableDateStrings.filter(dateString => {
      const deliveryDate = new Date(dateString + 'T00:00:00');
      return (deliveryDate.getTime() - now.getTime()) >= cutoffMs;
    });

    if (validDates.length === 0) {
      deliveryDatesContainerEl.innerHTML = '<p class="text-center text-red-500 text-sm">‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á</p>';
      return;
    }

    validDates.forEach(dateString => {
      const deliveryDate = new Date(dateString + 'T00:00:00');
      const formattedDate = deliveryDate.toLocaleDateString('th-TH', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      const id = `date-${dateString}`;
      deliveryDatesContainerEl.innerHTML += `
        <div class="flex items-center">
          <input type="checkbox" id="${id}" name="deliveryDate" value="${dateString}" class="h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
          <label for="${id}" class="ml-3 block text-sm text-gray-900">${formattedDate}</label>
        </div>`;
    });
  };

  const renderFloatingCart = () => {
    const isPaymentPage = !paymentSection.classList.contains('hidden');
    if (order.totalItems > 0 && !isPaymentPage) {
      openCartPopupBtnEl.innerHTML = `
        <span>üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (${order.totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
        <span class="font-extrabold text-lg">‡∏ø${order.total.toFixed(2)}</span>`;
      floatingCartBtnEl.classList.remove('hidden');
    } else {
      floatingCartBtnEl.classList.add('hidden');
    }
  };

  updateTotal = () => {
    let subtotal = 0, totalItems = 0;
    Object.values(order.items).forEach(item => {
      subtotal += item.price * item.quantity;
      totalItems += item.quantity;
    });
    order.subtotal = subtotal;
    order.totalItems = totalItems;

    if(order.discount && (subtotal < order.discount.minSpend || totalItems < order.discount.minItems)) {
      order.discount = null;
      discountInfoEl.textContent = '';
    }

    let discountValue = 0;
    if (order.discount) {
      discountValue = order.discount.type === 'percent' 
        ? (subtotal * order.discount.value) / 100 
        : order.discount.value;

  // ‚úÖ ‡∏Ñ‡∏∏‡∏°‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (maxDiscount)
  if (typeof order.discount.maxDiscount === 'number') {
    discountValue = Math.min(discountValue, order.discount.maxDiscount);
  }
}

order.total = Math.max(0, subtotal - discountValue);

    if (subtotalPriceEl) subtotalPriceEl.textContent = `‡∏ø${(order.subtotal || 0).toFixed(2)}`;
    if (totalPriceEl) totalPriceEl.textContent       = `‡∏ø${(order.total    || 0).toFixed(2)}`;

    if (order.discount) {
      discountAmountEl.textContent = `-‡∏ø${discountValue.toFixed(2)}`;
      discountCodeDisplayEl.textContent = order.discount.code;
      discountDisplaySectionEl.classList.remove('hidden');
    } else {
      discountDisplaySectionEl.classList.add('hidden');
    }

    renderFloatingCart();
    if (cartSidebarEl.classList.contains('open')) {
      renderCartSidebarContent();
    }
  };

  const renderMenu = () => {
    menuItemsEl.innerHTML = menu.map(item => {
      return `
        <div class="p-4 bg-gray-50 rounded-xl card space-y-3">
          <div class="flex items-start space-x-4">
            <img src="${item.imageUrl}" alt="${item.name}" class="w-24 h-24 rounded-lg object-cover flex-shrink-0">
            <div class="flex-1">
              <h3 class="font-bold text-gray-800">${item.name}</h3>
              <p class="text-xs text-gray-500 mt-1"><b class="text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°:</b> ${item.ingredients.replace(/, /g, ', ')}</p>
              <p class="text-xs text-gray-500 mt-1"><b class="text-gray-600">‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì:</b> ${item.properties}</p>
              <p class="text-sm text-gray-700 font-semibold mt-2">‡∏ø${item.sizes[0].price} - ‡∏ø${item.sizes[item.sizes.length-1].price}</p>
            </div>
            <button onclick="openItemModal('${item.id}')"
                    class="w-10 h-10 flex items-center justify-center rounded-full text-white text-2xl font-bold bg-emerald-600 hover:bg-emerald-700 transition-colors flex-shrink-0">
              +
            </button>
          </div>
        </div>
      `;
    }).join('');
  };

  const renderOrderSummary = (container, data, isFinalSummary) => {
    container.innerHTML = '';
    if (isFinalSummary) {
      const fields = [
        ['Order ID', data.queueNumber],
        ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á', new Date(data.orderDate).toLocaleString('th-TH', { timeZone:'Asia/Bangkok' })],
        ['‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', data.deliveryDates.map(d => new Date(d+'T00:00:00').toLocaleDateString('th-TH', { weekday:'short', day:'numeric', month:'short' })).join(', ')],
        ['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', data.customerName],
        ['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', data.customerContact.phone]
      ];
      if (data.deliveryLocationLabel) {
        fields.push(['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', data.deliveryLocationLabel]);
      }
      if (data.customerNote) fields.push(['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', data.customerNote]);
      container.innerHTML += fields.map(([label, value]) => `<p class="text-sm"><b class="font-semibold">${label}:</b> ${value}</p>`).join('');
    }

    container.innerHTML += '<h4 class="font-bold mt-4 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</h4>';
    const itemsToRender = Array.isArray(data.items) ? data.items : Object.values(data.items);

    itemsToRender.forEach(item => {
      container.innerHTML += `<p class="text-sm text-gray-600 ml-2">- ${item.name} (${item.size}) x ${item.quantity} (‡∏ø${(item.price * item.quantity).toFixed(2)})</p>`;
      if (item.allergies && item.allergies.length > 0) {
        container.innerHTML += `<p class="ml-6 text-xs text-red-500">‡πÅ‡∏û‡πâ: ${item.allergies.join(', ')}</p>`;
      }
    });

    if(isFinalSummary) {
      let summaryHTML = `<div class="mt-2 pt-2 border-t text-sm text-right">`;
      summaryHTML += `<p>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${data.subtotal.toFixed(2)}</p>`;
      if (data.discount) {
  let discountAmount =
    data.discount.type === 'fixed'
      ? data.discount.value
      : (data.subtotal * data.discount.value) / 100;

  // ‚úÖ ‡∏Ñ‡∏∏‡∏°‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (maxDiscount)
  if (typeof data.discount.maxDiscount === 'number') {
    discountAmount = Math.min(discountAmount, data.discount.maxDiscount);
  }

  summaryHTML += `<p class="text-red-500">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${data.discount.code}): -‡∏ø${discountAmount.toFixed(2)}</p>`;
}
      summaryHTML += `<p class="text-base font-bold mt-1">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span class="text-xl text-emerald-600">‡∏ø${data.total.toFixed(2)}</span></p></div>`;
      container.innerHTML += summaryHTML;
    }
  };

  openCartPopupBtnEl.addEventListener('click', openCartSidebar);
  closeCartBtnEl.addEventListener('click', closeCartSidebar);
  cartOverlayEl.addEventListener('click', closeCartSidebar);

  checkoutFromCartBtnEl.addEventListener('click', () => {
    closeCartSidebar();
    renderOrderSummary(orderSummaryEl, { items: Object.values(order.items) }, false);
    updateTotal();
    orderFormSection.classList.add('hidden');
    paymentSection.classList.remove('hidden');
    floatingCartBtnEl.classList.add('hidden');

    requestAnimationFrame(() => {
      window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
      customerNameEl.focus({ preventScroll: true });
      customerNameEl.scrollIntoView({ block: 'start', inline: 'nearest', behavior: 'auto' });
      paymentSection.scrollTop = 0;
    });
  });

  backToMenuBtn.addEventListener('click', () => {
    paymentSection.classList.add('hidden');
    orderFormSection.classList.remove('hidden');
    renderFloatingCart();
  });

  modalOverlayEl.addEventListener('click', closeItemModal);

  applyDiscountBtnEl.addEventListener('click', () => {
    const code = discountCodeInputEl.value.trim().toUpperCase();
    if (!code) return;
    const found = local_discountCodes.find(c => c.code === code);

    const today = new Date(); today.setHours(0,0,0,0);
    const expiry = found ? new Date(found.expiryDate) : null;
    if(expiry) expiry.setHours(23,59,59,999);

    let msg = '', color = 'red';
    if (!found) msg = '‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    else if (today > expiry) msg = '‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';
    else if (order.subtotal < found.minSpend) msg = `‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡∏ø${found.minSpend}`;
    else if (order.totalItems < found.minItems) msg = `‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${found.minItems} ‡∏Ç‡∏ß‡∏î`;
    else { order.discount = found; msg = '‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'; color = 'green'; }

    discountInfoEl.className = 'text-sm mt-2 h-5';
    if (color === 'green') discountInfoEl.classList.add('text-green-600');
    else discountInfoEl.classList.add('text-red-600');

    discountInfoEl.textContent = msg;
    if (color === 'red') order.discount = null;
    updateTotal();
  });

  uploadSlipBtn.addEventListener('click', async () => {
    const name = customerNameEl.value.trim();
    const phone = customerPhoneEl.value.trim();
    const note = customerNoteEl.value.trim();
    const locationKey = deliveryLocationEl.value;
    const selectedDates = Array.from(deliveryDatesContainerEl.querySelectorAll('input:checked')).map(node => node.value);
    const slipFile = slipUploadEl.files[0];

    if(!name) return showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠','red');
    if(!/^\d{10}$/.test(phone)) return showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å','red');
    if(!locationKey) return showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á','red');
    if(selectedDates.length === 0) return showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á','red');
    if(!slipFile) return showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ','red');

    uploadSlipBtn.disabled = true;
    uploadSlipTextEl.classList.add('hidden');
    uploadSlipSpinnerEl.classList.remove('hidden');

    const finalOrder = {
      queueNumber: getOrderQueueNumber(), customerName: name,
      customerContact: { phone },
      customerNote: note,
      deliveryLocationKey: locationKey,
      deliveryLocationLabel: deliveryConfig[locationKey]?.label || '',
      deliveryDates: selectedDates, orderDate: new Date().toISOString(),
      items: Object.values(order.items).filter(i=>i.quantity>0),
      subtotal: order.subtotal,
      discount: order.discount, total: order.total, totalItems: order.totalItems
    };

    const formData = new FormData();
    formData.append('slipImage', slipFile);
    Object.entries(finalOrder).forEach(([key, value]) => {
      formData.append(key, typeof value === 'object' ? JSON.stringify(value) : value);
    });

    try {
      await fetchWithRetry(n8nWebhookUrl, { method:'POST', body:formData });
      renderOrderSummary(finalOrderSummaryEl, finalOrder, true);
      paymentSection.classList.add('hidden');
      confirmationSection.classList.remove('hidden');
      floatingCartBtnEl.classList.add('hidden');
    } catch(err){
      console.error('Error sending data:', err);
      showMessageBox('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','red');
    } finally {
      uploadSlipBtn.disabled = false;
      uploadSlipTextEl.classList.remove('hidden');
      uploadSlipSpinnerEl.classList.add('hidden');
    }
  });

  slipUploadEl.addEventListener('change', e => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = evt => {
        slipPreviewEl.src = evt.target.result;
        slipPreviewContainerEl.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    } else {
      slipPreviewContainerEl.classList.add('hidden');
    }
  });

  copyAccountBtn.addEventListener('click', () => {
    const account = getEl('bank-account-number').textContent.split(': ')[1];
    navigator.clipboard.writeText(account).then(()=>showMessageBox('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß!','green'));
  });

  deliveryDatesContainerEl.addEventListener('change', () => {
    const selectedCount = deliveryDatesContainerEl.querySelectorAll('input:checked').length;
    deliveryWarningEl.classList.toggle('hidden', selectedCount <= 1);
  });

  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÉ‡∏´‡πâ render ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô
  deliveryLocationEl.addEventListener('change', () => {
    const key = deliveryLocationEl.value;
    renderDeliveryDates(key);
  });

  renderMenu();
  updateTotal();
  // ‡πÅ‡∏£‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äú‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‚Äù
  renderDeliveryDates();
});
</script>
</body>
</html>






